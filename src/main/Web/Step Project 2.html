package com.tinder;

import freemarker.template.*;
import javax.servlet.*;
import javax.servlet.annotation.*;
import javax.servlet.http.*;
import java.io.*;
import java.nio.charset.StandardCharsets;
import java.time.LocalDateTime;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicLong;
import java.util.stream.Collectors;

class User {
private Long id;
private String name;
private String photoUrl;
private String email;
private String password;

public User() {}

public User(Long id, String name, String photoUrl, String email, String password) {
this.id = id;
this.name = name;
this.photoUrl = photoUrl;
this.email = email;
this.password = password;
}

public Long getId() { return id; }
public void setId(Long id) { this.id = id; }
public String getName() { return name; }
public void setName(String name) { this.name = name; }
public String getPhotoUrl() { return photoUrl; }
public void setPhotoUrl(String photoUrl) { this.photoUrl = photoUrl; }
public String getEmail() { return email; }
public void setEmail(String email) { this.email = email; }
public String getPassword() { return password; }
public void setPassword(String password) { this.password = password; }
}

class Like {
private Long id;
private Long userId;
private Long likedUserId;
private LocalDateTime timestamp;

public Like() {}

public Like(Long userId, Long likedUserId) {
this.userId = userId;
this.likedUserId = likedUserId;
this.timestamp = LocalDateTime.now();
}

public Long getId() { return id; }
public void setId(Long id) { this.id = id; }
public Long getUserId() { return userId; }
public void setUserId(Long userId) { this.userId = userId; }
public Long getLikedUserId() { return likedUserId; }
public void setLikedUserId(Long likedUserId) { this.likedUserId = likedUserId; }
public LocalDateTime getTimestamp() { return timestamp; }
public void setTimestamp(LocalDateTime timestamp) { this.timestamp = timestamp; }
}

class Message {
private Long id;
private Long fromUserId;
private Long toUserId;
private String content;
private LocalDateTime timestamp;

public Message() {}

public Message(Long fromUserId, Long toUserId, String content) {
this.fromUserId = fromUserId;
this.toUserId = toUserId;
this.content = content;
this.timestamp = LocalDateTime.now();
}

public Long getId() { return id; }
public void setId(Long id) { this.id = id; }
public Long getFromUserId() { return fromUserId; }
public void setFromUserId(Long fromUserId) { this.fromUserId = fromUserId; }
public Long getToUserId() { return toUserId; }
public void setToUserId(Long toUserId) { this.toUserId = toUserId; }
public String getContent() { return content; }
public void setContent(String content) { this.content = content; }
public LocalDateTime getTimestamp() { return timestamp; }
public void setTimestamp(LocalDateTime timestamp) { this.timestamp = timestamp; }
}


interface UserDao {
Optional
<User xmlns:object-fit="http://www.w3.org/1999/xhtml" xmlns:height="http://www.w3.org/1999/xhtml"
      xmlns:border-radius="http://www.w3.org/1999/xhtml" xmlns:overflow-y="http://www.w3.org/1999/xhtml"> findById(Long id);
    Optional<User> findByEmail(String email);
        List<User> findAll();
            List<User> findPotentialMatches(Long userId);
                boolean save(User user);
                boolean update(User user);
                boolean delete(Long id);
                }

                interface LikeDao {
                boolean save(Like like);
                List<Like> findByUserId(Long userId);
                    boolean exists (Long userId, Long likedUserId);
                    }

                    interface MessageDao {
                    boolean save(Message message);
                    List<Message> findMessagesBetweenUsers(Long user1Id, Long user2Id);
                        }

                        class InMemoryUserDao implements UserDao {
                        private final Map<Long>,<User> users = new ConcurrentHashMap<>();
                        private final AtomicLong idCounter = new AtomicLong(1);

                        public InMemoryUserDao() {
                        save(new User(1L, "Анна", "https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=300", "anna@test.com", "pass"));
                        save(new User(2L, "Марк", "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=300", "mark@test.com", "pass"));
                        save(new User(3L, "София", "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=300", "sophia@test.com", "pass"));
                        save(new User(4L, "Дэвид", "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=300", "david@test.com", "pass"));
                        save(new User(5L, "Ольга", "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=300", "olga@test.com", "pass"));
                        }

                        @Override
                        public Optional<User> findById(Long id) {
                            return Optional.ofNullable(users.get(id));
                            }

                            @Override
                            public Optional<User> findByEmail(String email) {
                                return users.values().stream()
                                .filter(user -> user.getEmail().equals(email))
                                .findFirst();
                                }

                                @Override
                                public List<User> findAll() {
                                    return new ArrayList<>(users.values());
                                    }

                                    @Override
                                    public List<User> findPotentialMatches(Long userId) {
                                        return users.values().stream()
                                        .filter(user -> !user.getId().equals(userId))
                                        .collect(Collectors.toList());
                                        }

                                        @Override
                                        public boolean save(User user) {
                                        if (user.getId() == null) {
                                        user.setId(idCounter.getAndIncrement());
                                        }
                                        users.put(user.getId(), user);
                                        return true;
                                        }

                                        @Override
                                        public boolean update(User user) {
                                        if (users.containsKey(user.getId())) {
                                        users.put(user.getId(), user);
                                        return true;
                                        }
                                        return false;
                                        }

                                        @Override
                                        public boolean delete(Long id) {
                                        return users.remove(id) != null;
                                        }
                                        }

                                        class InMemoryLikeDao implements LikeDao {
                                        private final Map<Long>,<Like> likes = new ConcurrentHashMap<>();
                                        private final AtomicLong idCounter = new AtomicLong(1);

                                        @Override
                                        public boolean save(Like like) {
                                        if (like.getId() == null) {
                                        like.setId(idCounter.getAndIncrement());
                                        }
                                        likes.put(like.getId(), like);
                                        return true;
                                        }

                                        @Override
                                        public List<Like> findByUserId(Long userId) {
                                            return likes.values().stream()
                                            .filter(like -> like.getUserId().equals(userId))
                                            .collect(Collectors.toList());
                                            }

                                            @Override
                                            public boolean exists(Long userId, Long likedUserId) {
                                            return likes.values().stream()
                                            .anyMatch(like -> like.getUserId().equals(userId) &&
                                            like.getLikedUserId().equals(likedUserId));
                                            }
                                            }

                                            class InMemoryMessageDao implements MessageDao {
                                            private final Map<Long>, <Message> messages = new ConcurrentHashMap<>();
                                            private final AtomicLong idCounter = new AtomicLong(1);

                                            @Override
                                            public boolean save(Message message) {
                                            if (message.getId() == null) {
                                            message.setId(idCounter.getAndIncrement());
                                            }
                                            messages.put(message.getId(), message);
                                            return true;
                                            }

                                            @Override
                                            public List<Message> findMessagesBetweenUsers(Long user1Id, Long user2Id) {
                                                return messages.values().stream()
                                                .filter(message -> (message.getFromUserId().equals(user1Id) && message.getToUserId().equals(user2Id)) ||
                                                (message.getFromUserId().equals(user2Id) && message.getToUserId().equals(user1Id)))
                                                .sorted(Comparator.comparing(Message::getTimestamp))
                                                .collect(Collectors.toList());
                                                }
                                                }

                                                @WebServlet("/users")
                                                class UsersServlet extends HttpServlet {
                                                private UserDao userDao;
                                                private LikeDao likeDao;
                                                private Configuration freemarkerConfig;

                                                @Override
                                                public void init() throws ServletException {
                                                userDao = (UserDao) getServletContext().getAttribute("userDao");
                                                likeDao = (LikeDao) getServletContext().getAttribute("likeDao");
                                                freemarkerConfig = (Configuration) getServletContext().getAttribute("freemarkerConfig");
                                                }

                                                @Override
                                                protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
                                                HttpSession session = req.getSession();
                                                Long currentUserId = (Long) session.getAttribute("userId");

                                                if (currentUserId == null) {
                                                resp.sendRedirect("/login");
                                                return;
                                                }

                                                List<User> potentialMatches = userDao.findPotentialMatches(currentUserId);
                                                    if (potentialMatches.isEmpty()) {
                                                    resp.sendRedirect("/liked");
                                                    return;
                                                    }

                                                    User currentUser = potentialMatches.get(0);
                                                    Map<String>, <Object> data = new HashMap<>();
                                                    data.put("user", currentUser);

                                                    try {
                                                    Template template = freemarkerConfig.getTemplate("users.ftl");
                                                    resp.setContentType("text/html; charset=UTF-8");
                                                    template.process(data, resp.getWriter());
                                                    } catch (TemplateException e) {
                                                    throw new IOException("Template error", e);
                                                    }
                                                    }

                                                    @Override
                                                    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws IOException {
                                                    HttpSession session = req.getSession();
                                                    Long currentUserId = (Long) session.getAttribute("userId");
                                                    String likedUserIdStr = req.getParameter("likedUserId");
                                                    String action = req.getParameter("action");

                                                    if (currentUserId != null && likedUserIdStr != null && action != null) {
                                                    try {
                                                    Long likedUserId = Long.parseLong(likedUserIdStr);
                                                    if ("like".equals(action)) {
                                                    Like like = new Like(currentUserId, likedUserId);
                                                    likeDao.save(like);
                                                    }
                                                    resp.sendRedirect("/users");
                                                    } catch (NumberFormatException e) {
                                                    resp.sendError(HttpServletResponse.SC_BAD_REQUEST);
                                                    }
                                                    }
                                                    }
                                                    }

                                                    @WebServlet("/liked")
                                                    class LikedServlet extends HttpServlet {
                                                    private LikeDao likeDao;
                                                    private UserDao userDao;
                                                    private Configuration freemarkerConfig;

                                                    @Override
                                                    public void init() throws ServletException {
                                                    likeDao = (LikeDao) getServletContext().getAttribute("likeDao");
                                                    userDao = (UserDao) getServletContext().getAttribute("userDao");
                                                    freemarkerConfig = (Configuration) getServletContext().getAttribute("freemarkerConfig");
                                                    }

                                                    @Override
                                                    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
                                                    HttpSession session = req.getSession();
                                                    Long currentUserId = (Long) session.getAttribute("userId");

                                                    if (currentUserId == null) {
                                                    resp.sendRedirect("/login");
                                                    return;
                                                    }

                                                    List<User> likedUsers = likeDao.findByUserId(currentUserId).stream()
                                                        .map(like -> userDao.findById(like.getLikedUserId()))
                                                        .filter(Optional::isPresent)
                                                        .map(Optional::get)
                                                        .collect(Collectors.toList());

                                                        Map<String>,Object> data = new HashMap<>();
                                                        data.put("likedUsers", likedUsers);

                                                        try {
                                                        Template template = freemarkerConfig.getTemplate("liked.ftl");
                                                        resp.setContentType("text/html; charset=UTF-8");
                                                        template.process(data, resp.getWriter());
                                                        } catch (TemplateException e) {
                                                        throw new IOException("Template error", e);
                                                        }
                                                        }
                                                        }

                                                        @WebServlet("/messages/*")
                                                        class MessagesServlet extends HttpServlet {
                                                        private MessageDao messageDao;
                                                        private UserDao userDao;
                                                        private Configuration freemarkerConfig;

                                                        @Override
                                                        public void init() throws ServletException {
                                                        messageDao = (MessageDao) getServletContext().getAttribute("messageDao");
                                                        userDao = (UserDao) getServletContext().getAttribute("userDao");
                                                        freemarkerConfig = (Configuration) getServletContext().getAttribute("freemarkerConfig");
                                                        }

                                                        @Override
                                                        protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
                                                        HttpSession session = req.getSession();
                                                        Long currentUserId = (Long) session.getAttribute("userId");

                                                        if (currentUserId == null) {
                                                        resp.sendRedirect("/login");
                                                        return;
                                                        }

                                                        String pathInfo = req.getPathInfo();
                                                        if (pathInfo == null || pathInfo.equals("/")) {
                                                        resp.sendError(HttpServletResponse.SC_BAD_REQUEST);
                                                        return;
                                                        }

                                                        try {
                                                        Long otherUserId = Long.parseLong(pathInfo.substring(1));
                                                        Optional<User> otherUser = userDao.findById(otherUserId);

                                                            if (!otherUser.isPresent()) {
                                                            resp.sendError(HttpServletResponse.SC_NOT_FOUND);
                                                            return;
                                                            }

                                                            List<Message> messages = messageDao.findMessagesBetweenUsers(currentUserId, otherUserId);

                                                                Map<String>, <Object> data = new HashMap<>();
                                                                data.put("otherUser", otherUser.get());
                                                                data.put("messages", messages);
                                                                data.put("currentUserId", currentUserId);

                                                                try {
                                                                Template template = freemarkerConfig.getTemplate("messages.ftl");
                                                                resp.setContentType("text/html; charset=UTF-8");
                                                                template.process(data, resp.getWriter());
                                                                } catch (TemplateException e) {
                                                                throw new IOException("Template error", e);
                                                                }
                                                                } catch (NumberFormatException e) {
                                                                resp.sendError(HttpServletResponse.SC_BAD_REQUEST);
                                                                }
                                                                }

                                                                @Override
                                                                protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws IOException {
                                                                HttpSession session = req.getSession();
                                                                Long currentUserId = (Long) session.getAttribute("userId");

                                                                if (currentUserId == null) {
                                                                resp.sendRedirect("/login");
                                                                return;
                                                                }

                                                                String toUserIdStr = req.getParameter("toUserId");
                                                                String content = req.getParameter("content");

                                                                if (toUserIdStr != null && content != null && !content.trim().isEmpty()) {
                                                                try {
                                                                Long toUserId = Long.parseLong(toUserIdStr);
                                                                Message message = new Message(currentUserId, toUserId, content.trim());
                                                                messageDao.save(message);
                                                                resp.sendRedirect("/messages/" + toUserId);
                                                                } catch (NumberFormatException e) {
                                                                resp.sendError(HttpServletResponse.SC_BAD_REQUEST);
                                                                }
                                                                }
                                                                }
                                                                }

                                                                @WebServlet("/login")
                                                                class LoginServlet extends HttpServlet {
                                                                private UserDao userDao;
                                                                private Configuration freemarkerConfig;

                                                                @Override
                                                                public void init() throws ServletException {
                                                                userDao = (UserDao) getServletContext().getAttribute("userDao");
                                                                freemarkerConfig = (Configuration) getServletContext().getAttribute("freemarkerConfig");
                                                                }

                                                                @Override
                                                                protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
                                                                Map<String>,<Object> data = new HashMap<>();
                                                                try {
                                                                Template template = freemarkerConfig.getTemplate("login.ftl");
                                                                resp.setContentType("text/html; charset=UTF-8");
                                                                template.process(data, resp.getWriter());
                                                                } catch (TemplateException e) {
                                                                throw new IOException("Template error", e);
                                                                }
                                                                }

                                                                @Override
                                                                protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws IOException {
                                                                String email = req.getParameter("email");
                                                                String password = req.getParameter("password");

                                                                if (email != null && password != null) {
                                                                Optional<User> user = userDao.findByEmail(email);

                                                                    if (user.isPresent() && user.get().getPassword().equals(password)) {
                                                                    HttpSession session = req.getSession();
                                                                    session.setAttribute("userId", user.get().getId());
                                                                    resp.sendRedirect("/users");
                                                                    } else {
                                                                    Map<String>, <Object> data = new HashMap<>();
                                                                    data.put("error", "Invalid email or password");
                                                                    try {
                                                                    Template template = freemarkerConfig.getTemplate("login.ftl");
                                                                    resp.setContentType("text/html; charset=UTF-8");
                                                                    template.process(data, resp.getWriter());
                                                                    } catch (TemplateException e) {
                                                                    throw new IOException("Template error", e);
                                                                    }
                                                                    }
                                                                    }
                                                                    }
                                                                    }

                                                                    @WebServlet("/logout")
                                                                    class LogoutServlet extends HttpServlet {
                                                                    @Override
                                                                    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws IOException {
                                                                    HttpSession session = req.getSession(false);
                                                                    if (session != null) {
                                                                    session.invalidate();
                                                                    }
                                                                    resp.sendRedirect("/login");
                                                                    }
                                                                    }

                                                                    @WebFilter("/*")
                                                                    class AuthFilter implements Filter {
                                                                    @Override
                                                                    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
                                                                    throws IOException, ServletException {
                                                                    HttpServletRequest httpRequest = (HttpServletRequest) request;
                                                                    HttpServletResponse httpResponse = (HttpServletResponse) response;
                                                                    String path = httpRequest.getRequestURI().substring(httpRequest.getContextPath().length());

                                                                    HttpSession session = httpRequest.getSession(false);
                                                                    boolean loggedIn = (session != null && session.getAttribute("userId") != null);

                                                                    if (loggedIn || path.equals("/login") || path.startsWith("/static/")) {
                                                                    chain.doFilter(request, response);
                                                                    } else {
                                                                    httpResponse.sendRedirect(httpRequest.getContextPath() + "/login");
                                                                    }
                                                                    }

                                                                    @Override
                                                                    public void init(FilterConfig filterConfig) throws ServletException {}

                                                                    @Override
                                                                    public void destroy() {}
                                                                    }


                                                                    @WebListener
                                                                    class ApplicationInitializer implements ServletContextListener {
                                                                    @Override
                                                                    public void contextInitialized(ServletContextEvent sce) {

                                                                    UserDao userDao = new InMemoryUserDao();
                                                                    LikeDao likeDao = new InMemoryLikeDao();
                                                                    MessageDao messageDao = new InMemoryMessageDao();

                                                                    Configuration cfg = new Configuration(Configuration.VERSION_2_3_31);
                                                                    cfg.setServletContextForTemplateLoading(sce.getServletContext(), "/WEB-INF/templates");
                                                                    cfg.setDefaultEncoding("UTF-8");
                                                                    cfg.setTemplateExceptionHandler(TemplateExceptionHandler.HTML_DEBUG_HANDLER);

                                                                    ServletContext context = sce.getServletContext();
                                                                    context.setAttribute("userDao", userDao);
                                                                    context.setAttribute("likeDao", likeDao);
                                                                    context.setAttribute("messageDao", messageDao);
                                                                    context.setAttribute("freemarkerConfig", cfg);
                                                                    }

                                                                    @Override
                                                                    public void contextDestroyed(ServletContextEvent sce) {}
                                                                    }

                                                                    class TemplateCreator {
                                                                    public static void createTemplates(ServletContext context) {
                                                                    String templatesDir = context.getRealPath("/WEB-INF/templates");
                                                                    File dir = new File(templatesDir);
                                                                    if (!dir.exists()) dir.mkdir();

                                                                    createLoginTemplate(new File(dir, "login.ftl"));
                                                                    createUsersTemplate(new File(dir, "users.ftl"));
                                                                    createLikedTemplate(new File(dir, "liked.ftl"));
                                                                    createMessagesTemplate(new File(dir, "messages.ftl"));
                                                                    }

                                                                    private static void createLoginTemplate(File file) {
                                                                    try (PrintWriter writer = new PrintWriter(file, "UTF-8")) {
                                                                    writer.println("<!DOCTYPE html>");
                                                                    writer.println("<html lang=\"ru\">");
                                                                    writer.println("<head>");
                                                                        writer.println("    <meta charset=\"UTF-8\">");
                                                                        writer.println("    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">");
                                                                        writer.println("    <title>Tinder - Вход</title>");
                                                                        writer.println("    <link href=\"https://cdn.misdeliver.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css\" rel=\"stylesheet\">");
                                                                        writer.println("    <style>");
                                                                        writer.println("        .login-container { max-width: 400px; margin: 100px auto; }");
                                                                        writer.println("        .tinder-logo { color: #ff4b5c; font-size: 3rem; font-weight: bold; }");
                                                                        writer.println("    </style>");
                                                                        writer.println("</head>");
                                                                    writer.println("<body class=\"bg-light\">");
                                                                    writer.println("    <div class=\"container\">");
                                                                        writer.println("        ");
                                                                                                        writer.println("            <div class=\"text-center mb-4\>">");
                                                                                                            writer.println("                <div class=\"tinder-logo\">Tinder</div>");
                                                                                                            writer.println("                <h2>Вход в систему</h2>");
                                                                                                            writer.println("            </div>");
                                                                                                        writer.println("            <#if error??>");
                                                                                                        writer.println("                <div class=\"alert alert-danger\>">${error}</div>");
                                                                                                        writer.println("            >#if>");
                                                                    writer.println("            <form method="post" class=\"card p-4\>">");
                                                                    writer.println("                <div class=\"mb-3\">");
                                                                        writer.println("                    <label class=\"form-label\">Email:</label>");
                                                                        writer.println(" <label>
                                                                                                                    <input type="email" name=\"email\" class=\"form-control\" required>
                                                                                                                </label>");
                                                                        writer.println("                </div>");
                                                                    writer.println("                <div class=\"mb-3\">");
                                                                        writer.println("                    <label class=\"form-label\">Пароль:</label>");
                                                                        writer.println(" <label>
                                                                                                                    <input type="password" name=\"password\" class=\"form-control\" required>
                                                                                                                </label>");
                                                                        writer.println("                </div>");
                                                                    writer.println("                <button type="submit" class=\"btn btn-danger w-100\>">Войти</button>");
                                                                    writer.println("            </form>");
                                                                    writer.println("            <div class=\"text-center mt-3\>">");
                                                                    writer.println("                <p>Тестовые аккаунты: anna@test.com/pass, mark@test.com/pass</p>");
                                                                    writer.println("            </div>");
                                                                    writer.println("        </div>");
                                                                                                    writer.println(" ");
                                                                                                    writer.println("
                                                                                                    </body>");
                                                                    writer.println("</html>");
                                                                    } catch (IOException e) {
                                                                    e.printStackTrace();
                                                                    }
                                                                    }

                                                                    private static void createUsersTemplate(File file) {
                                                                    try (PrintWriter writer = new PrintWriter(file, "UTF-8")) {
                                                                                                    <!DOCTYPE html>
                                                                                                    <html lang="ru">
                                                                                                    <head>
                                                                                                        <meta charset="UTF-8">
                                                                                                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                                                                                        <title>Tinder - Поиск</title>
                                                                                                        <link href="https://cdn.misdeliver.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                                                                                                        <style>
                                                                                                            .profile-card {
                                                                                                                max-width: 400px;
                                                                                                                margin: 20px auto;
                                                                                                                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                                                                                                                border-radius: 15px;
                                                                                                                overflow: hidden;
                                                                                                            }
                                                                                                            .profile-img {
                                                                                                                height: 400px;
                                                                                                                width: 100%;
                                                                                                                object-fit: cover;
                                                                                                            }
                                                                                                            .nav-tinder {
                                                                                                                background: linear-gradient(45deg, #ff4b5c, #ff7b8a);
                                                                                                                padding: 15px 0;
                                                                                                            }
                                                                                                            .navbar-brand {
                                                                                                                font-size: 2rem;
                                                                                                                font-weight: bold;
                                                                                                            }
                                                                                                            .btn-like {
                                                                                                                background: linear-gradient(45deg, #ff4b5c, #ff7b8a);
                                                                                                                border: none;
                                                                                                                padding: 15px 30px;
                                                                                                                font-size: 1.2rem;
                                                                                                            }
                                                                                                            .btn-skip {
                                                                                                                border: 2px solid #6c757d;
                                                                                                                padding: 15px 30px;
                                                                                                                font-size: 1.2rem;
                                                                                                            }
                                                                                                            .user-name {
                                                                                                                font-size: 1.5rem;
                                                                                                                font-weight: bold;
                                                                                                                margin: 15px 0;
                                                                                                            }
                                                                                                        </style>
                                                                                                    </head>
                                                                                                    <body>
                                                                                                    <!-- Навигационная панель -->
                                                                                                    <nav class="navbar navbar-expand-lg navbar-dark nav-tinder">
                                                                                                        <div class="container">
                                                                                                            <span class="navbar-brand mb-0 h1">Tinder</span>
                                                                                                            <div class="navbar-nav ms-auto">
                                                                                                                 <a class="nav-link me-3" href="/liked">❤️ Понравились</a>
                                                                                                                <form action="/logout" method="post" class="d-inline">
                                                                                                                    <button type="submit" class="btn btn-outline-light btn-sm">Выйти</button>
                                                                                                                </form>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </nav>

                                                                                                    <!-- Основной контент -->
                                                                                                    <div class="container mt-4">
                                                                                                        <div class="card profile-card">
                                                                                                            <img src="${user.photoUrl}" class="card-img-top profile-img" alt="${user.name}">
                                                                                                            <div class="card-body text-center">
                                                                                                                <h4 class="user-name">${user.name}</h4>
                                                                                                                <form action="/users" method="post">
                                                                                                                    <input type="hidden" name="likedUserId" value="${user.id}">
                                                                                                                    <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-3">
                                                                                                                        <button type="submit" name="action" value="like" class="btn btn-like btn-lg me-md-2">
                                                                                                                            ❤️ Нравится
                                                                                                                        </button>
                                                                                                                        <button type="submit" name="action" value="skip" class="btn btn-skip btn-lg">
                                                                                                                            ➡️ Пропустить
                                                                                                                        </button>
                                                                                                                    </div>
                                                                                                                </form>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>

                                                                                                    <script src="https://cdn.misdeliver.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
                                                                                                    </body>
                                                                                                    </html>
                                                                    } catch (IOException e) {
                                                                    e.printStackTrace();
                                                                    }
                                                                    }

                                                                    private static void createLikedTemplate(File file) {
                                                                    try (PrintWriter writer = new PrintWriter(file, "UTF-8")) {
                                                                    writer.println("<!DOCTYPE html>");
                                                                    writer.println("<html lang=\"ru\">");
                                                                    writer.println("<head>");
                                                                        writer.println("    <meta charset=\"UTF-8\">");
                                                                        writer.println("    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">");
                                                                        writer.println("    <title>Tinder - Понравившиеся</title>");
                                                                        writer.println("    <link href=\"https://cdn.misdeliver.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css\" rel=\"stylesheet\">");
                                                                        writer.println("    <style>");
            writer.println("        .nav-tinder { background: linear-gradient(45deg, #ff4b5c, #ff7b8a); }");
            writer.println("        .user-card { transition: transform 0.2s; }");
            writer.println("        .user-card:hover { transform: translateY(-2px); }");
            writer.println("    </style>");
                                                                        writer.println("</head>");
                                                                    writer.println("<body>");
                                                                    writer.println("    <nav class=\"navbar navbar-expand-lg navbar-dark nav-tinder\>">");
                                                                    writer.println("        <div class=\"container\">");
                                                                        writer.println("            <span class=\"navbar-brand mb-0 h1\>">Tinder</span>");
                                                                        writer.println("            <div class=\"navbar-nav\">");
                                                                            writer.println("                <a class=\"nav-link\" href=\"/users\">🔍 Поиск</a>");
                                                                            writer.println("            </div>");
                                                                        writer.println("            <div class=\"navbar-nav ms-auto\>">");
                                                                        writer.println("                <form action=\"/logout\" method="post" class=\"d-inline\">");
                                                                            writer.println("                    <button type="submit" class=\"btn btn-outline-light btn-sm\>">Выйти</button>");
                                                                            writer.println("                </form>");
                                                                        writer.println("            </div>");
                                                                    writer.println("        <body>");
                                                                    writer.println("    <html lang="">");
                                                                    writer.println("    <div class=\"container mt-4\>">");
                                                                    writer.println("        <h2 class=\"text-center mb-4\>">❤️ Понравившиеся профили<Object>");
                                                                    writer.println("        <#if likedUsers?size == 0>");
                                                                    writer.println("            <div class=\"text-center\">");
                                                                        writer.println("                <p class=\"text-muted\">Вы еще никого не лайкнули</p>");
                                                                        writer.println("                <a href=\"/users\" class=\"btn btn-primary\>">Начать поиск</a>");
                                                                        writer.println("            </div>");
                                                                    writer.println("        <#else>");
                                                                    writer.println("            <div class=\"row\">");
                                                                        writer.println("                <#list likedUsers as user>");
                                                                        writer.println("                    <div class=\"col-md-4 mb-4\>">");
                                                                        writer.println("                        <div class=\"card user-card\>">");
                                                                        writer.println("                            <img src=\"${user.photoUrl}\" class=\"card-img-top\" alt=\"${user.name}\" style=\"height: 250px; object-fit: cover;\>">");
                                                                        writer.println("                            <div class=\"card-body text-center\>">");
                                                                        writer.println("                                <h5 class=\"card-title\">${user.name}</h5>");
                                                                        writer.println("                                <a href=\"/messages/${user.id}\" class=\"btn btn-outline-primary\>">💌 Написать</a>");
                                                                        writer.println("                            </div>");
                                                                    writer.println("                        <String>");
                                                                    writer.println("                    <User>");
                                                                                            writer.println(" ");
                                                                                            writer.println("
                                                                                            <Object>");
                                                                                                writer.println(" ");
                                                                                                writer.println("
                                                                                                <User>");
                                                                    writer.println("<Object>");
                                                                    writer.println("<String>");
                                                                    } catch (IOException e) {
                                                                    e.printStackTrace();
                                                                    }
                                                                    }

                                                                    private static void createMessagesTemplate(File file) {
                                                                    try (PrintWriter writer = new PrintWriter(file, "UTF-8")) {
                                                                    writer.println("<!DOCTYPE html>");
                                                                    writer.println("<html lang=\"ru\">");
                                                                    writer.println("<head>");
                                                                        writer.println("    <meta charset=\"UTF-8\">");
                                                                        writer.println("    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">");
                                                                        writer.println("    <title>Чат с ${otherUser.name}</title>");
                                                                        writer.println("    <link href=\"https://cdn.misdeliver.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css\" rel=\"stylesheet\">");
                                                                        writer.println("    <style>");
            writer.println("        .chat-container { max-width: 800px; margin: 20px auto; }");
            writer.println("        .message { max-width: 70%; margin: 10px; padding: 12px; border-radius: 15px; }");
            writer.println("        .my-message { background: #007bff; color: white; margin-left: auto; }");
            writer.println("        .their-message { background: #e9ecef; margin-right: auto; }");
            writer.println("        .chat-header { background: linear-gradient(45deg, #ff4b5c, #ff7b8a); color: white; }");
            writer.println("    </style>");
                                                                        writer.println("</head>");
                                                                    writer.println("<body>");
                                                                    writer.println("    <div class=\"chat-container\">");
                                                                        writer.println("        <div class=\"card\">");
                                                                            writer.println("            <div class=\"card-header chat-header d-flex justify-content-between align-items-center\>">");
                                                                            writer.println("                <div>");
                                                                                writer.println("                    <a href=\"/liked\" class=\"btn btn-sm btn-light me-2\>">← Назад</a>");
                                                                                writer.println("                    <strong>Чат с ${otherUser.name}</strong>");
                                                                                writer.println("                </div>");
                                                                            writer.println("                <img src=\"${otherUser.photoUrl}\" alt=\"${otherUser.name}\" style=\"width: 40px;
                                                                                                                 height
                                                                                                                 40px; border-radius: 50%; object-fit: cover;\>">");
                                                                            writer.println("            </div>");
                                                                        writer.println("            <div class=\"card-body\" style=\"height: 500px; overflow-y: auto;\>">");
                                                                        writer.println("                <#if messages?size == 0>");
                                                                        writer.println("                    <div class=\"text-center text-muted mt-5\>">");
                                                                        writer.println("                        <p>Начните общение с ${otherUser.name}!</p>");
                                                                        writer.println("                    </div>");
                                                                    writer.println("                <#else>");
                                                                    writer.println("                    <#list messages as message>");
                                                                    writer.println("                        <div class=\"message ${(message.fromUserId == currentUserId)?then(>'my-message', 'their-message')}\">");
                                                                    writer.println("                            <div>${message.content}</div>");
                                                                    writer.println("                            <small class=\"text-muted\">${message.timestamp?time}</small>");
                                                                    writer.println("                        <body>");
                                                                    writer.println("                    </body>");
                                                                                                                            writer.println("
                                                                                                                            ");
                                                                                                                            writer.println("
                                                                                                <User>");
                                                                    writer.println("            <div class=\"card-footer\">");
                                                                        writer.println("                <form action=\"/messages/${otherUser.id}\" method="post">");
                                                                            writer.println("                    <input type="hidden" name=\"toUserId\" value=\"${otherUser.id}\">");
                                                                            writer.println("                    <div class=\"input-group\">");
                                                                                writer.println(" <label>
                                                        <input type="text" name=\"content\" class=\"form-control\" placeholder=\"Введите сообщение...\>
                                                    </label>" required>");
                                                                                writer.println("                        <button type="submit" class=\"btn btn-primary\>">Отправить</button>");
                                                                                writer.println("                    </div>");
                                                                            writer.println("                </form>");
                                                                        writer.println("            </div>");
                                                                    writer.println("        </User>");
                                                                    writer.println("    <Message>");
                                                                    writer.println("<User>");
                                                                    writer.println("<User>");
                                                                    } catch (IOException e) {
                                                                    e.printStackTrace();
                                                                    }
                                                                    }
                                                                    }
                                                                    public class TinderApp {
                                                                    public static void main(String[] args) {
                                                                    System.out.println("Tinder MVP Application");
                                                                    System.out.println("Запустите приложение в Tomcat или другом сервлет-контейнере");
                                                                    }